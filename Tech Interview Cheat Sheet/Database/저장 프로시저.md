# 저장 프로시저(Stroed Procedure)

**저장 프로시저(Stroed Procedure)** 는 일련의 쿼리를 마치 하나의 **함수** 처럼 실행하기 위한 쿼리의 집합이다.  
데이터베이스에 대한 일련의 작업을 정리한 절차를 관계형 데이터베이스 관리 시스템에 저장한것으로, 영구저장모듈(Persistent Storage Module)이라고도 불린다.

![call_sto](https://user-images.githubusercontent.com/66757141/213897835-18ba67ae-7046-40e7-947e-8b14f2f70ff1.gif)

`Oracle`, `MySQL`, `MSSQL` 등 대부분의 DBMS 에서 저장 프로시저 기능을 제공하고 있다.  
Oracle의 경우 아래와 같이 프로시저를 생성하고 실행할 수 있다.

```sql
CREATE PROCEDURE procedure_name(IN parameter)
  BEGIN
    SQL1;
    SQL2;
  END;
  /

EXECUTE procedure_name(parameter);
CALL procedure_name(parameter);
```

<br/>

## 저장 프로시저 사용에 따른 동작 비교

[📄*Reference devkingdom*](https://devkingdom.tistory.com/323)

### 저장 프로시저를 사용하지 않은 경우

저장 프로시저를 사용하지 않고 SQL문을 사용하는 경우 아래와 같이 동작한다.  
_마이크로소프트의 T-SQL 기준_

<img src="https://user-images.githubusercontent.com/66757141/213897841-0ad8716c-fd26-4801-97b6-5cdb486c388c.png" alt="" width="520" />

1. **구문분석** | 구문 자체에 오류가 없는지 분석한다.
2. **개체 이름 확인** | SQL 문 내에 사용되는 테이블과 컬럼명이 있는지 등을 확인한다.
3. **사용 권한 확인** | 현재 접근중인 사용자가 권한이 있는지를 확인한다.
4. **최적화** | 해당 쿼리문이 가장 좋은 성능을 낼 수 있는 경로를 결정한다. 사실상 인덱스 사용 여부에 따라 경로가 결정된다.
5. **컴파일 및 실행계획 등록** | 최적화 결과를 바탕으로 실행 계획 결과를 메모리(캐시)에 등록한다.
6. **실행** | 컴파일된 결과를 실행한다.

<img src="https://user-images.githubusercontent.com/66757141/213897844-15646a92-8127-44e4-b817-c5a8de46e432.png" alt="" width="380" />

이후 동일한 SQL문을 실행하면 위와 같이 동작한다.  
여러 과정이 생략되므로 시간이 단축된다.  
하지만 쿼리 전체가 한글자도 틀리지 않고 같아야한다.

<br/>

### 저장 프로시저를 사용한 경우

저장 프로시저를 사용하는 경우 아래와 같이 동작한다.

<img src="https://user-images.githubusercontent.com/66757141/213897845-5dd71aae-8c96-42c0-b5b0-91a9e2c688f6.png" alt="" width="460" />

먼저 저장 프로시저를 위와 같이 생성한다.

1. **구문분석** | 해당 프로시저에 구문 오류가 있는지 분석한다.
2. **지연된 이름 확인(deferred name resolution)** |  
   저장 프로시저의 특성으로 사용된 테이블 등의 개체 존재 여부와 상관 없이 정의가 가능하다. 테이블의 존재 여부를 프로시저의 실행 시점에 확인하기 때문이다.
3. **생성 권한 확인** | 사용자가 저장 프로시저를 생성할 권한이 있는지 확인한다.
4. **시스템 테이블 등록** | 저장 프로시저의 이름과 코드를 관련 시스템 테이블에 등록한다.

<img src="https://user-images.githubusercontent.com/66757141/213897849-2290afc1-a0c6-4cd2-bbcb-dae85e23b612.png" alt="" width="440" />

저장한 프로시저를 첫 번째로 실행했을 때 다음과 같이 동작한다. 일반 쿼리문을 처음 실행했을 때와 비슷한 동작이다.

앞서 프로시저를 생성할 때에 `지연된 이름 확인`이 있었는데, 이에 대한 실제 테이블 등의 개체 존재 확인을 여기에서 진행하게 된다.  
그 이후 단계는 앞서 일반 쿼리문을 사용했을 때와 동일하게 동작한다.

<img src="https://user-images.githubusercontent.com/66757141/213897850-a5fa80bd-6584-4e33-a3f9-dbc5905efe27.png" alt="" width="400" />

두 번째 실행부터는 메모리(캐시)에 있는 것을 그대로 가져와 사용하게 되어 수행시간이 많이 단축된다.

```sql
SELECT * FROM userTable WHERE name = '최다인'
SELECT * FROM userTable WHERE name = '이도하'
SELECT * FROM userTable WHERE name = '이규현'
```

위와 같이 파라미터만 달라도 일반 SQL문을 사용하면 다른 쿼리로 인식해 복잡한 과정을 모두 거치게된다.

```sql
CREATE PROC select_by_name
	@Name NVARCHAR(3)
AS
	SELECT * FROM userTable WHERE name =@name;
```

```sql
EXEC select_by_name '최다인';
EXEC select_by_name '이도하';
EXEC select_by_name '이규현';
```

저장 프로시저를 사용하면 첫 실행해서 최적화 및 컴파일을 수행하고, 나머지는 메모리(캐시)에 있는것을 사용하게된다. 자주 쓰는 저장 프로시저를 쓰는것이 성능적인 측면에서 효과적이다.

<br/>

## 저장 프로시저의 장점

1. **SQL 서버 성능 향상**  
   변수만 다른 동일한 쿼리문의 저장 프로시저를 사용하면, 최초 실행시 최적화 및 컴파일되어 캐시(메모리)에 저장되고, 이 후에는 바로 캐시에서 가져오게 되어 빠르다.

2. **유지보수 및 재사용**  
   SQL문을 캡슐화하여 **코드 재사용** 이 가능하고, 수정시에도 응용프로그램의 재배포 없이 **저장프로시저만 수정 및 배포** 하면 되기 때문에 유지보수가 편리하다.

3. **보안 강화**  
    저장 프로시저는 자체적인 보안 설정 기능을 가지고 있어,
   사용자별이 아닌 프로그램 단위로 권한 설정이 가능하여 보안을 강화할 수 있다. SQL 인젝션과 같은 기본적인 보안사고 역시 피할 수 있다. _[Prepared Statement](https://github.com/da-in/tech-interview-study/blob/main/Tech%20Interview%20Cheat%20Sheet/Database/SQL%20Injection.md#sql-%EC%9D%B8%EC%A0%9D%EC%85%98-%EB%8C%80%EC%9D%91)와 유사한 원리이다._

4. **네트워크 트래픽 감소**  
   저장 프로시저를 사용하면 클라이언트가 직접 SQL문을 작성하지 않고, 프로시저 명과 매개변수만을 전달하여 서버에 저장된 SQL문을 사용하므로, 클라이언트와 서버의 부하를 줄일 수 있다.

<br/>

## 저장 프로시저의 단점

1. **호환성**  
   구문 규칙이 SQL / PSM 표준과의 호환성이 낮기 때문에 코드 자산으로의 재사용성이 나쁘다.

2. **성능**  
   프로시저 내부에 연산이 포함될 경우 CPU 점유율이 높아지고 실행시간도 길어지므로 LOCK이 걸려있을 경우 병목이 될 확률이 높아진다.

3. **디버깅 어려움**  
   저장 프로시저가 어디에서 사용되었는지 확인이 어렵고, 에러가 발생했을 때 어디서 잘못됐는지 디버깅하는 것이 힘들 수 있다.

<br/>

---

## Reference

**저장 프로시저와 일반 SQL의 동작 과정 비교**  
✨https://devkingdom.tistory.com/323

📄https://ko.wikipedia.org/wiki/저장_프로시저  
📄https://siahn95.tistory.com/entry/DBMSSQL-저장-프로시저Stored-Procedure란
📄https://goldswan.tistory.com/51
